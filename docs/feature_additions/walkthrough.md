# 変更内容の確認 (Walkthrough)

## 実装された機能

### 1. スマートタイトル & スケジューリング
- **機能**: 目標作成時に、Gemini がより具体的で魅力的なタイトルを提案し、各タスクの期限から逆算した最適なスケジュールを設定します。
- **確認方法**:
    1. 新しい目標を作成します (例: "英語を勉強する", 期限: 1週間後)。
    2. 生成された目標のタイトルが "1週間で英語の基礎をマスターする" のように最適化されていることを確認します。
    3. 各タスクに日付が設定されており、期限に向けてスケジュールされていることを確認します。

### 2. デイリールーチン & 通知
- **機能**: タスクに「毎日」「毎週」などの繰り返し設定が可能になり、設定された時間にローカル通知が届きます。
- **確認方法**:
    1. 目標作成時、"毎日英語を聞く" などのタスクが含まれる場合、自動的に「毎日」の繰り返し設定が適用されます。
    2. アプリ起動時に通知の許可を求められます。
    3. 設定された時間に通知が届くことを確認します (シミュレータの場合は設定が必要)。

### 3. チャットインターフェース (自然言語調整)
- **機能**: Gemini と対話して、目標やタスクを自然言語で調整できます。
- **確認方法**:
    1. 目標詳細画面の右上にある「吹き出しアイコン」をタップします。
    2. チャット画面で「タスクAを削除して」「期限を3日延ばして」「もっと詳細なタスクを追加して」などの指示を送ります。
    3. Gemini が指示を理解し、目標 (タスクリスト) が更新されることを確認します。

### 4. コーディングルール準拠 & アーキテクチャ改善
- **View/ViewModel分離**: `GoalChatView` と `GoalChatViewModel` を別ファイルに分離。
- **プレビュー実装**: `GoalChatView` に `#Preview` を追加。
- **依存性注入パターン**: `NotificationManager` をシングルトンから依存性注入パターンに変更し、テスタビリティと Swift Concurrency との相性を改善。

### 5. カレンダー機能の大幅改善
- **目標ごとのイベント識別**: `[目標: {タイトル}]` プレフィックスで各目標のイベントを識別し、他の目標に影響しないように改善。
- **既存予定との重複回避**: カレンダーの既存イベントを取得し、重ならない空き時間を自動で見つけてタスクを配置。
- **曜日別作業時間帯**: 設定画面から曜日ごとに異なる開始・終了時刻を設定可能（例: 平日9-18時、週末13-17時）。
- **カレンダー削除機能**: チャット画面から目標のカレンダーイベントを削除できるボタンを追加。

### 6. 目標の開始日機能
- **開始日の自動設定**: 目標作成時に`startDate`を自動設定（作成日時と同じ）。
- **過去への遡り防止**: タスクのスケジューリング時、開始日より前の日付にタスクを配置しない。
- **スケジュール見直し**: チャットでスケジュールを見直す際も、過去に遡らないように制御。

## ファイル変更一覧

### Core
- `Goal.swift`: 
    - `TaskRecurrence` 列挙型と `recurrence` プロパティを追加 (デフォルト値で既存データとの互換性を確保)。
    - `startDate` プロパティを追加（デフォルトは `createdAt` と同じ）。
- `GeminiService.swift`:
    - `generateTasks`: 最適化されたタイトル、スケジュール、繰り返し設定を返すように更新。タスクが開始日より前にならないように制御。
    - `updateGoal`: チャットによる目標更新メソッドを追加。スケジュール見直し時に過去に遡らないように制御。
- `NotificationManager.swift`: 
    - `NotificationManaging` プロトコルを作成し、依存性注入パターンを実装。
    - シングルトンパターンを削除。
- `CreateGoalUseCase.swift`: 
    - 最適化されたタイトルを使用。
    - `NotificationManaging` を依存性として注入。
- `CalendarService.swift`:
    - 目標ごとのイベント識別（プレフィックス付与）。
    - 既存予定との重複を回避するスケジューリングロジック。
    - UserDefaultsから作業時間帯を読み取り。
    - `removeExistingEvents` メソッドで目標ごとのイベント削除。

### Feature
- `GoalChatViewModel.swift`: `GoalChatView` から分離して新規作成。`removeCalendarEvents` メソッドを追加。
- `GoalChatView.swift`: 
    - ViewModel を分離。
    - `#Preview` を追加。
    - `NotificationManaging` 依存性を受け取るように更新。
    - カレンダー削除ボタンをツールバーに追加。
- `GoalDetailView.swift`: チャット画面への遷移ボタンを追加。
- `GoalListView.swift`: `CreateGoalUseCase` に `NotificationManager` を注入。
- `GoalInputView.swift`: Preview に `NotificationManager` を追加。
- `SettingsView.swift`: 作業時間帯設定セクション（`WorkHoursSettingsCard`）を追加。
- `mybest_tasksApp.swift`: 
    - `NotificationManager` インスタンスを作成し、初期化時に通知許可をリクエスト。

### Documentation
- `docs/coding_rules.md`: コーディングルールを新規作成。

## 技術的な改善点

### SwiftData互換性
- `recurrence` プロパティに完全修飾名 (`TaskRecurrence.none`) のデフォルト値を設定し、既存データとの互換性を確保。

### Swift Concurrency対応
- シングルトンパターンを依存性注入パターンに変更し、テスタビリティと並行処理の安全性を向上。

## 次のステップ
- 通知の細かい設定 (時間指定など) をユーザーが変更できるUIの追加。
- チャット画面での履歴の永続化。
- テストコードの追加 (`NotificationManaging` プロトコルを使用したモックテスト)。
